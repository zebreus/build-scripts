From 97cd81313925c470fc00269f37e4f43b66456563 Mon Sep 17 00:00:00 2001
From: Zebreus <zebreus@zebre.us>
Date: Thu, 14 Aug 2025 17:10:23 +0200
Subject: [PATCH] Fix python build

---
 python/BUILD.bazel      |  4 ++--
 python/dist/BUILD.bazel | 15 +++++++++------
 python/dist/dist.bzl    |  3 ++-
 python/internal.bzl     |  2 +-
 4 files changed, 14 insertions(+), 10 deletions(-)

diff --git a/python/BUILD.bazel b/python/BUILD.bazel
index f1c384a8f..2b955d9f8 100644
--- a/python/BUILD.bazel
+++ b/python/BUILD.bazel
@@ -104,8 +104,8 @@ selects.config_setting_group(
 
 _message_target_compatible_with = {
     "@platforms//os:windows": ["@platforms//:incompatible"],
-    "@system_python//:none": ["@platforms//:incompatible"],
-    "@system_python//:unsupported": ["@platforms//:incompatible"],
+#    "@system_python//:none": ["@platforms//:incompatible"],
+#    "@system_python//:unsupported": ["@platforms//:incompatible"],
     "//conditions:default": [],
 }
 
diff --git a/python/dist/BUILD.bazel b/python/dist/BUILD.bazel
index e7d32cb1f..11073ef87 100644
--- a/python/dist/BUILD.bazel
+++ b/python/dist/BUILD.bazel
@@ -11,13 +11,15 @@ load("@protobuf_pip_deps//:requirements.bzl", "requirement")
 load("@rules_pkg//pkg:mappings.bzl", "pkg_files", "strip_prefix")
 load("@rules_pkg//pkg:tar.bzl", "pkg_tar")
 load("@rules_python//python:packaging.bzl", "py_wheel")
-load("@system_python//:version.bzl", "SYSTEM_PYTHON_VERSION")
+#load("@system_python//:version.bzl", "SYSTEM_PYTHON_VERSION")
 load("//:protobuf_version.bzl", "PROTOBUF_PYTHON_VERSION")
 load(":dist.bzl", "py_dist", "py_dist_module")
 load(":py_proto_library.bzl", "py_proto_library")
 
 licenses(["notice"])
 
+SYSTEM_PYTHON_VERSION = "3"
+
 py_dist_module(
     name = "message_mod",
     extension = "//python:_message_binary",
@@ -294,7 +296,7 @@ pkg_tar(
     package_file_name = "protobuf.tar.gz",
     strip_prefix = ".",
     target_compatible_with = select({
-        "@system_python//:none": ["@platforms//:incompatible"],
+#        "@system_python//:none": ["@platforms//:incompatible"],
         "//conditions:default": [],
     }),
 )
@@ -313,7 +315,7 @@ genrule(
         mv protobuf/dist/*.tar.gz $@
     """,
     target_compatible_with = select({
-        "@system_python//:none": ["@platforms//:incompatible"],
+#        "@system_python//:none": ["@platforms//:incompatible"],
         "//conditions:default": [],
     }),
     tools = [requirement("setuptools")],
@@ -325,6 +327,7 @@ py_wheel(
         "//python:full_api_3.9": "cp39",
         "//conditions:default": "abi3",
     }),
+    visibility = ["//visibility:public"],
     author = "protobuf@googlegroups.com",
     author_email = "protobuf@googlegroups.com",
     classifiers = [
@@ -372,7 +375,7 @@ py_wheel(
         "src/",
     ],
     target_compatible_with = select({
-        "@system_python//:none": ["@platforms//:incompatible"],
+#        "@system_python//:none": ["@platforms//:incompatible"],
         "//conditions:default": [],
     }),
     version = PROTOBUF_PYTHON_VERSION,
@@ -412,7 +415,7 @@ py_wheel(
         "src/",
     ],
     target_compatible_with = select({
-        "@system_python//:none": ["@platforms//:incompatible"],
+#        "@system_python//:none": ["@platforms//:incompatible"],
         "//conditions:default": [],
     }),
     version = PROTOBUF_PYTHON_VERSION,
@@ -438,7 +441,7 @@ py_wheel(
         "src/",
     ],
     target_compatible_with = select({
-        "@system_python//:none": ["@platforms//:incompatible"],
+#        "@system_python//:none": ["@platforms//:incompatible"],
         "//conditions:default": [],
     }),
     version = PROTOBUF_PYTHON_VERSION,
diff --git a/python/dist/dist.bzl b/python/dist/dist.bzl
index 7c9095e26..d1ebaf159 100644
--- a/python/dist/dist.bzl
+++ b/python/dist/dist.bzl
@@ -1,7 +1,8 @@
 """Rules to create python distribution files and properly name them"""
 
 load("@bazel_skylib//rules:common_settings.bzl", "BuildSettingInfo")
-load("@system_python//:version.bzl", "SYSTEM_PYTHON_VERSION")
+#load("@system_python//:version.bzl", "SYSTEM_PYTHON_VERSION")
+SYSTEM_PYTHON_VERSION = "3"
 
 def _get_suffix(limited_api, python_version, cpu):
     """Computes an ABI version tag for an extension module per PEP 3149."""
diff --git a/python/internal.bzl b/python/internal.bzl
index c9be66e10..6bc923984 100644
--- a/python/internal.bzl
+++ b/python/internal.bzl
@@ -134,7 +134,7 @@ def internal_py_test(deps = [], **kwargs):
             "@com_google_absl_py//absl/testing:parameterized",
         ],
         target_compatible_with = select({
-            "@system_python//:supported": [],
+#            "@system_python//:supported": [],
             "//conditions:default": ["@platforms//:incompatible"],
         }),
         **kwargs
-- 
2.48.1

